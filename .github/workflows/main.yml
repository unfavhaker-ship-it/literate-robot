name: Free 16GB Windows RDP - Fixed Password

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest   # 4 vCPU + 16 GB RAM

    steps:
    - name: Checkout code (if needed)
      uses: actions/checkout@v4

    - name: Enable RDP + Create Admin User (Fixed: No ! in Pass)
      run: |
        net user TanmayAdmin MySecurePass2026 /add
        net localgroup "Administrators" TanmayAdmin /add
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 1 /f
        netsh advfirewall firewall set rule group="remote desktop" new enable=yes
      shell: cmd   # CMD use karo â€“ PowerShell mein ! issue avoid

    - name: Download and Install Tailscale
      run: |
        try {
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale.exe" -UseBasicParsing
          Start-Process -FilePath "tailscale.exe" -ArgumentList "/S" -Wait
          Write-Output "Tailscale installed successfully."
        } catch {
          Write-Error "Tailscale install failed: $_"
        }
      shell: pwsh

    - name: Connect Tailscale (with retry)
      run: |
        $attempt = 1
        do {
          try {
            & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --accept-routes --accept-dns=false --reset
            Write-Output "Tailscale connected on attempt $attempt"
            break
          } catch {
            Write-Warning "Attempt $attempt failed. Retrying in 10s..."
            Start-Sleep -Seconds 10
            $attempt++
          }
        } while ($attempt -le 3)
      shell: pwsh

    - name: Show Tailscale Status & Your IP
      run: |
        Start-Sleep -Seconds 60
        & "C:\Program Files\Tailscale\tailscale.exe" status
        & "C:\Program Files\Tailscale\tailscale.exe" ip -4
      shell: pwsh

    - name: Confirm RAM - Should be around 16 GB
      run: |
        Get-ComputerInfo | Select-Object WindowsProductName, CsTotalPhysicalMemory
        systeminfo | Select-String "Total Physical Memory"
      shell: pwsh

    - name: Keep VM Alive for Max 6 Hours
      run: Start-Sleep -Seconds 21600
